<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />	
	<!-- prototype stuff -->
	<script type="text/javascript" src="libs/prototype.js"></script>
	<script type="text/javascript" src="libs/effects.js"></script>

	<!-- classess -->
	<script src="class/http_connector.js" type="text/javascript" charset="utf-8"></script>
	<script src="class/service.js" type="text/javascript" charset="utf-8"></script>
	<script src="class/interface.js" type="text/javascript" charset="utf-8"></script>
	<script src="class/blip/blip.js" type="text/javascript" charset="utf-8"></script>
	<script src="class/blip/blipi.js" type="text/javascript" charset="utf-8"></script>
	<script src="class/blip/updates.js" type="text/javascript" charset="utf-8"></script>
	<script src="class/flaker/flaker.js" type="text/javascript" charset="utf-8"></script>

	<!-- szit -->
	<script type="text/javascript" charset="utf-8">
		Interface.notify(Titanium.App.getName(),Titanium.App.getVersion());

		var services = new Array();
		var username,loop1 ="";
		document.observe('dom:loaded',function(){
			Titanium.userAgent = Titanium.App.getName() +  " " + Titanium.App.getVersion();
			try {
				var saved_u = Titanium.App.Properties.getString("username");
				var saved_p = Titanium.App.Properties.getString("password");
				$$('input[name="username"]').first().setValue(saved_u);
				$$('input[name="pass"]').first().setValue(saved_p);
			}
			catch(er) {
				console.dir(er);
			}
			$('sender').toggle();
			$('throbber').toggle();
			Element.observe('login_form','submit',function(event){
				username = $F(this['username']);
				var pass = $F(this['pass']);
				services.push( new Blip(username, pass));
				// TODO it works - so make it happen somewhere else
				// idealy would be to have one loop, that just runs stuff
				// but depeneding on different services
				// we might create separate intervals...
				services[0].dashboardProcess = Interface.Dashboard.draw;
				services[0].afterSend = Interface.afterSend;
				services[0].dashboardGet();
				Interface.notify(Titanium.App.getName(),'Pobieram kokpit');
				loop1 = new PeriodicalExecuter(run_loop1,10);
				function run_loop1() {
					$('throbber').toggle();
					services[0].dashboardGet();
				}
				// TODO this should be somewhere else
				Titanium.App.Properties.setString('username',username);
				Titanium.App.Properties.setString('password',pass);

				this.fade();
				$('throbber').toggle();
				$('sender').toggle();
				event.preventDefault();
			});
			Element.observe('sender','submit',function(event){
				event.preventDefault();
				if($F(this['content']).length <= 160) {
					$('throbber').toggle();
					this.disable();
					var blyp = $F(this['content']);
					services[0].createBlip(blyp);
				} else {
					yy = $F(this['content']).length - 160;
					Interface.notify("Błęd", "Treść za długa o "+yy+" znaków");
				}
			});
			Element.observe('main_textarea','keydown',function(event){
				var content = this.getValue();
				if(event.keyCode == 13) {
					if( content.length <= 160){
						event.preventDefault();
						$('throbber').toggle();
						$('sender').disable();
						services[0].createBlip(content);
					} else {
						Interface.notify("Błęd", "Treść za długa o "+(content.length - 160)+" znaków");
					}
				}
				$('charcount').update(content.length);
			});
			Element.observe('mark_as_read_button','click',function(event){
				event.preventDefault();
				var unread = $$('.unread');

				for(var i=19, l = unread.length;i<l;i++) {
					unread[i].remove();
				}
				unread.each(function(el) { el.removeClassName('unread'); } );
				Interface.setUnreadCount('0');
			});
			Element.observe('make_private','click',function(event){
				Interface.setAreaContent('>',true);
				$('main_textarea').toggleClassName('priv_t');
			});
			Element.observe('shorten_links','click',function(event){
				event.preventDefault();
				var content = $('main_textarea').getValue();
				console.log("tresc z element.observe.click\n\t"+content);
				Interface.shortenLinksInString(content, services[0].shortenLink);

			});
			// Pagination
			Element.observe('home_link','click',function(event) {
				services[0].dashboard_last_id=0;
				services[0].dashboardProcess = Interface.Dashboard.draw;
				services[0].dashboardGet();
				event.preventDefault();
				$('current_page').update();
				loop1 = new PeriodicalExecuter(run_loop1,10);
				function run_loop1() {
					$('throbber').toggle();
					services[0].dashboardGet();
				}
			});
			Element.observe('next_page','click',function(event) {
				loop1.stop();
				event.preventDefault();
				services[0].dashboardProcess = Interface.Dashboard.drawPage;
				services[0].dashboard_last_id=0;
				services[0].current_page = services[0].current_page + 1;
				var p =services[0].current_page;
				console.log(p);
				console.log(services[0].current_page);
				services[0].dashboardGet(p);
				$('current_page').update("Strona: "+p);
				console.log(services[0].current_page);
			});
			Element.observe('previous_page','click',function(event) {
				loop1.stop();
				event.preventDefault();
				services[0].dashboardProcess = Interface.Dashboard.drawPage;
				services[0].dashboard_last_id=0;
				services[0].current_page = services[0].current_page - 1;
				var p =services[0].current_page;
				console.log(p);
				console.log(services[0].current_page);
				$('current_page').update("Strona: "+p);
				services[0].dashboardGet(p);
				console.log(services[0].current_page);
			});
		});
		
	</script>
	<link rel="stylesheet" href="style.css" type="text/css" media="screen" charset="utf-8"/>
	<link rel="stylesheet" href="win32.css" type="text/css" media="screen" charset="utf-8"/>
	<link rel="stylesheet" href="linux.css" type="text/css" media="screen" charset="utf-8"/>
</head>
<body>
	<div id="wrapper">


		<div id="controls">
			<!-- login form -->
			<form action="#" method="" accept-charset="utf-8" id="login_form">
				<label for="Login">Login</label>
					<input type="text" name="username" value=""/>
				<label for="pass">Hasło</label>
					<input type="password" name="pass" value=""/>
				<input type="submit" class="button" value="Zaloguj &rarr;">
			</form>
		<!-- update content form -->
	<div id="paginator">
		<a class="button" href="#" id="previous_page">&larr;</a>
		<a class="button" href="#" id="home_link">Kokpit</a>
		<a class="button" href="#" id="next_page">&rarr;</a>
		<span id="current_page" class="button"></span>
		<a href="#" class="button small" id="mark_as_read_button">Oznacz jako przeczytane [<span id="unread_count"></span>]</a>
	</div>
		<form action="#" method="" id="sender" accept-charset="utf-8">
			<textarea  id="main_textarea" name="content" rows="3"  ></textarea>
			<div>
				<span id="charcount" class="button sender_item">0</span>
				<a href="#" class="button small sender_item" title="Zmienia wiadomość na prywatną" id="make_private">Sprywatyzuj</a>
				<a href="#" class="button small sender_item" title="Skraca wszystkie linki, które wpisano" id="shorten_links">Skróć linki</a>
			</div>
<!--			<input type="submit" class="button" value="Dodaj Obraz"> -->
<!--			<input type="submit" class="button" value="Wyślij &rarr;"> -->
			</form>
			<!-- controlls -->
			<div id="throbber"><img src="app://icons/anim.gif" /></div>
		</div>
		<!-- here b columns -->
		<div id="dash1" class="column">
			
		</div>
	</div>
</body>
</html>
