<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />	
	<!-- prototype stuff -->
	<script type="text/javascript" src="libs/prototype.js"></script>
	<script type="text/javascript" src="libs/effects.js"></script>

	<!-- classess -->
	<script src="class/http_connector.js" type="text/javascript" charset="utf-8"></script>
	<script src="class/service.js" type="text/javascript" charset="utf-8"></script>
	<script src="class/interface.js" type="text/javascript" charset="utf-8"></script>
	<script src="class/blip/blip.js" type="text/javascript" charset="utf-8"></script>
	<script src="class/blip/updates.js" type="text/javascript" charset="utf-8"></script>
	<script src="class/flaker/flaker.js" type="text/javascript" charset="utf-8"></script>

	<!-- szit -->
	<script type="text/javascript" charset="utf-8">
		Interface.notify(Titanium.App.getName(),Titanium.App.getVersion());

		var services = new Array();
        var username ="";
		document.observe('dom:loaded',function(){
            Titanium.userAgent = Titanium.App.getName() +  " " + Titanium.App.getVersion();
            try {
                var saved_u = Titanium.App.Properties.getString("username");
                var saved_p = Titanium.App.Properties.getString("password");
                $$('input[name="username"]').first().setValue(saved_u);
                $$('input[name="pass"]').first().setValue(saved_p);
            }
            catch(er) {
                console.dir(er);
            }
			$('sender').toggle();
			$('throbber').toggle();
            Element.observe('login_form','submit',function(event){
                username = $F(this['username']);
                var pass = $F(this['pass']);
                services.push( new Blip(username, pass));
                // TODO it works - so make it happen somewhere else
                // idealy would be to have one loop, that just runs stuff
                // but depeneding on different services
                // we might create separate intervals...
                services[0].dashboardProcess = Interface.Dashboard.draw;
                services[0].dashboardGet();
                Interface.notify(Titanium.App.getName(),'Pobieram kokpit');
                setInterval(function(){
                    $('throbber').toggle();
                    services[0].dashboardGet();
                }, 10000);

                // TODO this should be somewhere else
                Titanium.App.Properties.setString('username',username);
                Titanium.App.Properties.setString('password',pass);

                this.fade();
                $('throbber').toggle();
                $('sender').toggle();
                event.preventDefault();
                }
            );
            Element.observe('sender','submit',function(event){
                $('throbber').toggle();
                this.disable();
                var blyp = $F(this['content']);
                services[0].createBlip(blyp);
                event.preventDefault();
            });
            Element.observe('main_textarea','keydown',function(event){
                    
                    if(event.keyCode == 13) event.preventDefault();
                    $('charcount').update(this.getValue().length);

            });
            Element.observe('mark_as_read_button','click',function(event){
                event.preventDefault();
                $$('.unread').each(function(el) { el.removeClassName('unread') } );
                Interface.setUnreadCount('0');
            });
            Element.observe('make_private','click',function(event){
                Interface.setAreaContent('>',true);
                $('main_textarea').toggleClassName('priv_t');
            });
        });
		
	</script>
	<link rel="stylesheet" href="app://style.css" type="text/css" media="screen" charset="utf-8"/>
</head>
<body>
	<div id="wrapper">


		<div id="controls">
			<!-- login form -->
			<form action="#" method="" accept-charset="utf-8" id="login_form">
				<label for="Login">Login</label>
					<input type="text" name="username" value=""/>
				<label for="pass">Hasło</label>
					<input type="password" name="pass" value=""/>
				<input type="submit" class="button" value="Zaloguj &rarr;">
			</form>
		<!-- update content form -->
		<form action="#" method="" id="sender" accept-charset="utf-8">
			<textarea  id="main_textarea" name="content" rows="3"  ></textarea>
			<input type="submit" class="button" value="Wyślij &rarr;">
			<span id="charcount" class="button">0</span>
			</form>
			<!-- controlls -->
			<div>
				<a href="#" class="button small" id="mark_as_read_button">Oznacz jako przeczytane [<span id="unread_count"></span>]</a>
				<a href="#" class="button small" id="make_private">Sprywatyzuj</a>
			</div>
			<div id="throbber"><img src="app://icons/anim.gif" /></div>
		</div>
		<!-- here b columns -->
		<div id="dash1" class="column">
			
		</div>
	</div>
</body>
</html>
